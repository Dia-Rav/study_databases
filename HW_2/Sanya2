--part 1, task 2
select
DATEADD(day, 1, EOMONTH(dateId)) as dat, sum(salesRub) as 'Сумма за месяц'
from distributor.singleSales
group by EOMONTH(dateId)
order by EOMONTH(dateId)

--part 1, task 6
select
year(dateId) as year, DATEPART(QUARTER, dateId) as quarter, sum(salesRub) as 'Сумма за квартал'
from distributor.singleSales
group by year(dateId), DATEPART(QUARTER, dateId)
order by year(dateId), DATEPART(QUARTER, dateId)

--part 1, task 10
select
SUBSTRING(fullname, 1, CHARINDEX(' ',fullname)) as 'Фамилия', SUBSTRING(fullname, CHARINDEX(' ',fullname), len(fullname) - CHARINDEX(' ',fullname)) as 'Имя', SUBSTRING(fullname, 1, CHARINDEX(' ',fullname) + 1) + '.' as 'Фамилия И.'
from distributor.singleSales
group by fullname

--part 2, task 4
select branchName as 'Филиал', DATEADD(day, 1, EOMONTH(dateId)) as 'Дата начала месяца', brand as 'Бренд', sum(salesRub) as 'Выручка компании'
from (select distinct dateId, salesRub, b.branchName, c.brand from distributor.sales as a
left join distributor.branch as b
on a.branchId = b.branchId
left join distributor.item as c
on a.itemId = c.itemId) as d
group by branchName, EOMONTH(dateId), brand
order by branchName, EOMONTH(dateId), brand

-- part 2, task 8
select year(dateId) as 'Год', fullname as 'Менеджер', count(distinct companyId) as 'Количество компаний'
from (select dateId, b.fullname, companyId from distributor.sales as a
inner join distributor.salesManager as b
on a.salesManagerId = b.salesManagerId
WHERE b.fullname is not null and companyId is not null) as d
group by year(dateId), fullname
order by year(dateId)

--part 2, task 16
select brand, y, m, summ/all_sum as partitionn
from (
    SELECT brand, y, m, summ, SUM(summ) over(partition by y, m) as all_sum, ROW_NUMBER() over(partition by y, m order by y, m asc, summ desc) as n
    from (
        select distinct brand, year(dateId) as y, MONTH(dateId) as m, sum(salesRub) as summ from distributor.sales as a
        left join distributor.item as b
        on a.itemId = b.itemId
        where brand is not null
        group by brand, year(dateId), MONTH(dateId)) as c) as f
WHERE n < 4

--part 2, task 20

declare @vdate datetime
set @vdate = '12/01/15'

select fullname, dat, avg(summ) as 'Средний чек'
from(
    select avg(salesManagerId) as salesManagerid, DATEADD(day, 1, EOMONTH(dateId)) as dat, sum(salesRub) as summ
    from distributor.sales
    group by EOMONTH(dateId), checkId
    ) as a
inner join distributor.salesManager as b
on a.salesManagerid = b.salesManagerId
where dat = dateadd(month, -1, @vdate) or dat = dateadd(month, -2, @vdate) or dat = dateadd(month, -3, @vdate)
group by dat, fullname
